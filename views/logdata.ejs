<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Data</title>

    <!-- âœ… Google Font: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- âœ… Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: #ffffff;
            color: #333;
        }

        .wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* ===== HEADER ===== */
        header {
            background: #ffffff;
            padding: 12px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo img {
            margin-top: 5px;
            height: 70px;
            object-fit: contain;
        }

        .user-circle {
            width: 32px;
            height: 32px;
            background-color: #9ca3af;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }

        .user-dropdown {
            position: relative;
            display: inline-block;
        }

        .user-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 8px 0;
            min-width: 150px;
            z-index: 10;
        }

        .user-menu a {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
        }

        .user-menu a:hover {
            background-color: #f3f4f6;
        }

        .user-menu a.delete-account {
            color: #dc3545;
            font-weight: 500;
        }

        /* ===== MAIN ===== */
        .main {
            flex: 1;
            display: flex;
            background: #ffffff;
        }

        .main-nav ul {
            list-style: none;
            display: flex;
            gap: 26px;
            margin: 0;
            padding: 0;
            margin-left: 680px;
        }

        .main-nav ul li a {
            text-decoration: none;
            color: #111827;
            font-weight: 500;
            font-size: 14px;
            padding: 8px 14px;
            border-radius: 6px;
            transition: 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .main-nav ul li a:hover {
            color: #fff;
            background: #111827;
        }

        .main-nav ul li a.active {
            background: #111827;
            color: #fff;
        }

        .sidebar {
            width: 250px;
            background: #f9fafb;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 16px;
            margin: 24px;

            /* ðŸ”§ Atur tinggi sidebar */
            height: 455px;
            /* ganti sesuai keinginan, misal 400px, 450px, dll */
            overflow-y: auto;
            /* biar kalau kontennya lebih panjang, bisa discroll */
        }

        .sidebar .name {
            margin-top: 12px;
            font-size: 16px;
            font-weight: 600;
        }

        .sidebar .nav {
            margin-top: 24px;
            width: 100%;
        }

        .sidebar .nav-item {
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 11px !important;
            text-align: left;
            width: 100%;
            padding-left: 8px;
            cursor: pointer;
            line-height: 1.3;
            background: none;
        }

        #marketingToggle span {
            font-size: 11px !important;
            line-height: 1.3;
        }

        .sidebar form {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .sidebar form label img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            aspect-ratio: 1 / 1;
            border: 2px solid #e5e7eb;
            display: block;
        }

        .hidden {
            display: none;
        }

        .content {
            flex: 1;
            padding: 40px;
        }

        /* ===== PAGE TITLE (ikon rumah abu-abu + Dashboard) ===== */
        .page-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            color: #0a0b0b;
            margin-bottom: 24px;
        }

        .page-title i {
            color: #9ca3af;
            font-size: 15px;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 16px;
            font-size: 18px;
        }

        .title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 16px;
        }

        .filters {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filters select,
        .filters input {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 14px;
        }

        .filters button {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
        }

        /* ===== TABEL ===== */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }

        th,
        td {
            border: 1px solid #e5e7eb;
            padding: 10px 12px;
            text-align: left;
        }

        th {
            background: #f9fafb;
            color: #333333;
            font-weight: 600;
            text-align: center;
        }

        tbody tr {
            background: #ffffff;
        }

        td:last-child {
            text-align: center;
            vertical-align: middle;
        }

        .status-result {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-weight: 500;
            font-size: 13px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 6px;
        }

        .pagination button {
            min-width: 34px;
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.3s;
        }

        .pagination button[disabled] {
            opacity: .45;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #111827;
            color: #fff;
        }


        /* ===== STATUS ICON ===== */
        .status-result {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            font-size: 13px;
        }

        .status-result i {
            font-size: 15px;
        }

        /* Warna status */
        .status-result.pending {
            color: #f59e0b;
        }

        .status-result.success {
            color: #16a34a;
        }

        .status-result.failed {
            color: #dc2626;
        }

        .status-result.unknown {
            color: #9ca3af;
        }

        /* ===== AKSI (EDIT & DELETE) ===== */
        .action-buttons {
            text-align: center;
            vertical-align: middle;
        }

        .action-buttons a,
        .action-buttons button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
            margin: 0 4px;
        }

        .edit-icon {
            color: #2563eb;
            transition: 0.3s;
        }

        .edit-icon:hover {
            color: #1d4ed8;
        }

        .delete-icon {
            color: #dc2626;
            transition: 0.3s;
        }

        .delete-icon:hover {
            color: #b91c1c;
        }

        footer {
            background: #1f2937;
            color: #fff;
            text-align: left;
            padding: 32px 24px;
            font-size: 13px;
            min-height: 80px;
            margin-top: auto;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <header>
            <div class="logo">
                <img src="/img/koperasi-jatim-capital-logo.png" alt="Logo Koperasi Berkembang Bersama Kami">
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="/home">Home</a></li>
                    <li><a href="/dashboard">Dashboard</a></li>
                    <li><a href="/login">Log In</a></li>
                    <li><a href="/signup">Sign Up</a></li>
                </ul>
            </nav>

            <div class="user-dropdown">
                <div class="user-circle" id="userMenuToggle">
                    <%= user.first_name.charAt(0).toUpperCase() %>
                </div>
                <div class="user-menu hidden" id="userMenu">
                    <a href="/logout"><i class="fa-solid fa-right-from-bracket" style="color:#dc3545;"></i> Logout</a>
                    <form action="/delete-account" method="POST"
                        onsubmit="return confirm('Apakah Anda yakin ingin menghapus akun Anda?')" style="margin: 0;">
                        <button type="submit" class="delete-account"
                            style="background: none; border: none; width: 100%; text-align: left; padding: 8px 16px; color: #dc3545; font-weight: 500; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <i class="fa-solid fa-trash"></i> Delete Account
                        </button>
                    </form>
                </div>
            </div>
        </header>

        <div class="main">
            <aside class="sidebar">
                <form action="/upload-profile" method="POST" enctype="multipart/form-data">
                    <% const profileImage=user.profile_picture && user.profile_picture.trim() !=='' ?
                        user.profile_picture : '/img/profile.png' ; %>
                        <label for="profileUpload">
                            <img src="<%= profileImage %>" alt="Profile" onerror="this.src='/img/profile.png';" />
                        </label>
                        <input id="profileUpload" type="file" name="profile_picture" style="display: none;"
                            onchange="this.form.submit()" />
                </form>

                <div class="name">
                    <%= user.first_name %>
                        <%= user.last_name %>
                </div>

                <div class="nav">
                    <div class="nav-item" id="goMain">Dashboard</div>
                    <div class="nav-item">Notes</div>
                </div>
            </aside>

            <div class="content">
                <!-- Judul + Filter di kanan -->
                <div class="title-row">
                    <div class="page-title">
                        <i class="fa-solid fa-house"></i>
                        <span>Log Data</span>
                    </div>

                    <!-- âœ… FILTER -->
                    <div class="filters">
                        <select id="filterJenis">
                            <option value="">Semua Jenis</option>
                            <option value="perusahaan">Perusahaan</option>
                            <option value="perorangan">Perorangan</option>
                        </select>

                        <select id="filterKet">
                            <option value="">Semua Status</option>
                            <option value="pending">Pending</option>
                            <option value="lengkap">Lengkap</option>
                            <option value="tidak lengkap">Tidak Lengkap</option>
                        </select>

                        <input id="filterPerusahaan" type="text" placeholder="Cari nama perusahaanâ€¦">

                        <button id="resetFilter" type="button" title="Reset filter">
                            Reset
                        </button>
                    </div>
                </div>

                <!-- âœ… TABEL DATA -->
                <table id="logTable">
                    <thead>
                        <tr>
                            <th>Jenis Pemohon</th>
                            <th>Nama</th>
                            <th>Nama Perusahaan</th>
                            <th>Bidang Usaha</th>
                            <th>Keterangan</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% records.forEach((row, index)=> { %>
                            <tr data-row="1" data-jenis="<%= (row.jenis_pemohon || '').toLowerCase() %>"
                                data-perusahaan="<%= (row.nama_perusahaan || '').toLowerCase() %>"
                                data-status="<%= (row.keterangan || '').toLowerCase() %>">
                                <td>
                                    <%= row.jenis_pemohon %>
                                </td>
                                <td>
                                    <%= row.nama %>
                                </td>
                                <td>
                                    <%= row.nama_perusahaan %>
                                </td>
                                <td>
                                    <%= row.bidang_usaha %>
                                </td>
                                <td>
                                    <% if (row.keterangan && row.keterangan.toLowerCase()==='pending' ) { %>
                                        <div class="status-result pending">
                                            <i class="fa-solid fa-hourglass-half"></i>
                                            <span>PENDING</span>
                                        </div>
                                        <% } else if (row.keterangan && row.keterangan.toLowerCase()==='lengkap' ) { %>
                                            <div class="status-result success">
                                                <i class="fa-solid fa-circle-check"></i>
                                                <span>LENGKAP</span>
                                            </div>
                                            <% } else if (row.keterangan &&
                                                row.keterangan.toLowerCase()==='tidak lengkap' ) { %>
                                                <div class="status-result failed">
                                                    <i class="fa-solid fa-circle-xmark"></i>
                                                    <span>TIDAK LENGKAP</span>
                                                </div>
                                                <% } else { %>
                                                    <div class="status-result unknown">
                                                        <i class="fa-solid fa-question-circle"></i>
                                                        <span>-</span>
                                                    </div>
                                                    <% } %>
                                </td>
                                <td class="action-buttons">
                                    <!-- Tombol edit -->
                                    <a href="/document-checklist/<%= row.id %>/edit" title="Edit Data">
                                        <i class="fa-solid fa-pen-to-square edit-icon"></i>
                                    </a>

                                    <!-- Tombol delete -->
                                    <form action="/delete/<%= row.id %>" method="POST" style="display:inline;"
                                        onsubmit="return confirm('Apakah Anda yakin ingin menghapus data ini?');">
                                        <button type="submit" class="delete-btn" title="Hapus Data">
                                            <i class="fa-solid fa-trash delete-icon"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            <% }) %>
                    </tbody>
                </table>

                <!-- âœ… PAGINATION -->
                <div class="pagination" id="pagination"></div>
            </div>
        </div>

        <footer>Â© Jatim Capital 2025</footer>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const toggle = document.getElementById("userMenuToggle");
            const menu = document.getElementById("userMenu");

            toggle.addEventListener("click", () => menu.classList.toggle("hidden"));
            document.addEventListener("click", (e) => {
                if (!toggle.contains(e.target) && !menu.contains(e.target)) {
                    menu.classList.add("hidden");
                }
            });
            document.getElementById("goMain").addEventListener("click", function () {
                window.location.href = "/dashboard";
            });
        });

        // === PAGINATION + FILTER (max 3 nomor) ===
        const rowsPerPage = 6;
        const table = document.getElementById("logTable");
        const tbody = table.querySelector("tbody");
        const pagination = document.getElementById("pagination");

        // Filter controls
        const fJenis = document.getElementById("filterJenis");
        const fKet = document.getElementById("filterKet");
        const fPerusahaan = document.getElementById("filterPerusahaan");
        const btnReset = document.getElementById("resetFilter");

        // Kumpulan baris data asli (tanpa padding)
        const dataRows = Array.from(tbody.querySelectorAll('tr[data-row="1"]'));
        const cols = table.querySelectorAll("thead th").length;

        // Pool baris kosong (padding) akan dibuat dinamis
        const padClass = "pad-row";

        let currentPage = 1;
        const windowSize = 3; // maksimum nomor ditampilkan

        // ---------- Util ----------
        function norm(s) { return (s || "").toString().trim().toLowerCase(); }

        function getRowStatus(row) {
            // 1) pakai data-status kalau ada
            let s = row.dataset.status;
            if (s) return norm(s);
            // 2) fallback dari teks di cell status
            const cell = row.children[4]; // kolom keterangan
            if (!cell) return "";
            const span = cell.querySelector(".status-result span");
            return norm(span ? span.textContent : cell.textContent);
        }

        function ensurePadRows(countNeeded) {
            // Hapus semua pad-row lama
            tbody.querySelectorAll(`tr.${padClass}`).forEach(r => r.remove());
            // Tambahkan pad-row sesuai kebutuhan
            for (let i = 0; i < countNeeded; i++) {
                const tr = document.createElement("tr");
                tr.className = padClass;
                for (let j = 0; j < cols; j++) {
                    const td = document.createElement("td");
                    td.innerHTML = "&nbsp;";
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        // ---------- Filtering ----------
        function getFilteredRows() {
            const jenis = norm(fJenis.value);
            const ket = norm(fKet.value);
            const perusahaan = norm(fPerusahaan.value);

            return dataRows.filter(row => {
                const rJenis = norm(row.dataset.jenis);
                const rPerusahaan = norm(row.dataset.perusahaan);
                const rStatus = getRowStatus(row); // dari data-status / DOM

                const okJenis = !jenis || rJenis === jenis;
                const okKet = !ket || rStatus === ket;
                const okPerusahaan = !perusahaan || rPerusahaan.includes(perusahaan);

                return okJenis && okKet && okPerusahaan;
            });
        }

        // ---------- Pagination core ----------
        function createBtn(label, onClick, opts = {}) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.textContent = label;
            if (opts.title) btn.title = opts.title;
            if (opts.active) btn.classList.add("active");
            if (opts.disabled) btn.setAttribute("disabled", "disabled");
            btn.addEventListener("click", () => {
                if (!opts.disabled) onClick();
            });
            return btn;
        }

        function renderPagination(total) {
            const pageCount = Math.max(1, Math.ceil(total / rowsPerPage));
            const cp = currentPage = Math.min(currentPage, pageCount);

            pagination.innerHTML = "";

            // Â« first
            pagination.appendChild(
                createBtn("Â«", () => showPage(1), { title: "Halaman pertama", disabled: cp === 1 })
            );
            // â€¹ prev
            pagination.appendChild(
                createBtn("â€¹", () => showPage(cp - 1), { title: "Sebelumnya", disabled: cp === 1 })
            );

            // nomor (maks 3)
            let start = Math.max(1, cp - 1);
            let end = start + windowSize - 1;
            if (end > pageCount) { end = pageCount; start = Math.max(1, end - windowSize + 1); }

            for (let p = start; p <= end; p++) {
                pagination.appendChild(
                    createBtn(String(p), () => showPage(p), { active: p === cp, title: `Halaman ${p}` })
                );
            }

            // â€º next
            pagination.appendChild(
                createBtn("â€º", () => showPage(cp + 1), { title: "Berikutnya", disabled: cp === pageCount })
            );
            // Â» last
            pagination.appendChild(
                createBtn("Â»", () => showPage(pageCount), { title: "Halaman terakhir", disabled: cp === pageCount })
            );
        }

        function showPage(page) {
            const filtered = getFilteredRows();
            const total = filtered.length;
            const pageCount = Math.max(1, Math.ceil(total / rowsPerPage));
            currentPage = Math.min(Math.max(1, page), pageCount);

            // Sembunyikan semua data + pad-row
            [...dataRows, ...tbody.querySelectorAll(`tr.${padClass}`)].forEach(r => r.style.display = "none");

            // Range index
            const startIdx = (currentPage - 1) * rowsPerPage;
            const endIdx = Math.min(startIdx + rowsPerPage, total);

            // Tampilkan baris yang kepilih
            for (let i = startIdx; i < endIdx; i++) {
                filtered[i].style.display = "";
            }

            // Siapkan padding agar selalu 6 baris tampil
            const padNeeded = rowsPerPage - (endIdx - startIdx);
            ensurePadRows(padNeeded);
            // tampilkan pad-row (yang baru dibuat otomatis ada di akhir tbody)
            tbody.querySelectorAll(`tr.${padClass}`).forEach(r => r.style.display = "");

            // Render tombol paging sesuai total hasil filter
            renderPagination(total);
        }

        // ---------- Hook filter ----------
        function resetFilter() {
            fJenis.value = "";
            fKet.value = "";
            fPerusahaan.value = "";
            currentPage = 1;
            showPage(1);
        }

        function debounce(fn, ms = 250) {
            let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
        }

        fJenis.addEventListener("change", () => showPage(1));
        fKet.addEventListener("change", () => showPage(1));
        fPerusahaan.addEventListener("input", debounce(() => showPage(1), 250));
        btnReset.addEventListener("click", resetFilter);

        // ---------- Init ----------
        showPage(1);
    </script>
</body>

</html>