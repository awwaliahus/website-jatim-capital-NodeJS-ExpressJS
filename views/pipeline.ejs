<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pipeline</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif
        }

        body {
            background: #ffffff;
            color: #333
        }

        .wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh
        }

        /* Header */
        header {
            background: #fff;
            padding: 12px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb
        }

        .logo img {
            margin-top: 5px;
            height: 70px;
            object-fit: contain
        }

        .main {
            flex: 1;
            display: flex;
            background: #fff
        }

        .main-nav ul {
            list-style: none;
            display: flex;
            gap: 26px;
            margin: 0;
            padding: 0;
            margin-left: 680px
        }

        .main-nav ul li a {
            text-decoration: none;
            color: #111827;
            font-weight: 500;
            font-size: 14px;
            padding: 8px 14px;
            border-radius: 6px;
            transition: .3s ease
        }

        .main-nav ul li a:hover {
            color: #fff;
            background: #111827
        }

        .main-nav ul li a.active {
            background: #111827;
            color: #fff
        }

        .user-circle {
            width: 32px;
            height: 32px;
            background: #9ca3af;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            cursor: pointer
        }

        .user-dropdown {
            position: relative;
            display: inline-block
        }

        .user-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
            padding: 8px 0;
            min-width: 150px;
            z-index: 10
        }

        .user-menu a {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            color: #333;
            text-decoration: none;
            font-size: 14px
        }

        .user-menu a:hover {
            background: #f3f4f6
        }

        .user-menu a.delete-account {
            color: #dc3545;
            font-weight: 500
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #f9fafb;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 16px;
            margin: 24px;
            height: 455px;
            overflow-y: auto
        }

        .sidebar .name {
            margin-top: 12px;
            font-size: 16px;
            font-weight: 600
        }

        .sidebar .nav {
            margin-top: 24px;
            width: 100%
        }

        .sidebar .nav-item {
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 11px !important;
            text-align: left;
            width: 100%;
            padding-left: 8px;
            cursor: pointer;
            line-height: 1.3;
            background: none
        }

        .sidebar form label img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            aspect-ratio: 1/1;
            border: 2px solid #e5e7eb;
            display: block
        }

        /* Content */
        .content {
            flex: 1;
            padding: 40px
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            color: #0a0b0b;
            margin-bottom: 12px
        }

        .page-title i {
            color: #9ca3af;
            font-size: 15px
        }

        /* Pipeline table (match document-checklist look) */
        .pipeline-wrap {
            margin-top: 6px
        }

        .toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 10px 0 14px
        }

        .toolbar button {
            border: 1px solid #d1d5db;
            background: #111827;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer
        }

        .toolbar button.secondary {
            background: #fff;
            color: #111827
        }

        .toolbar button:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .table-scroll {
            overflow: auto;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: #fff
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        .pipeline {
            min-width: 980px
        }

        .pipeline th,
        .pipeline td {
            padding: 10px;
            border: 1px solid #e5e7eb;
            text-align: left;
            font-size: 14px;
            vertical-align: middle
        }

        .pipeline th {
            background: #f9fafb;
            font-weight: 600;
            text-align: center
        }

        .pipeline td:first-child {
            width: 64px;
            text-align: center
        }

        .pipeline td[contenteditable="true"] {
            outline: none
        }

        .pipeline td.active-cell {
            box-shadow: inset 0 0 0 2px #3b82f6
        }

        .pipeline td.active-row {
            background: #f8fafc
        }

        .pipeline td.active-col {
            background: #f8fafc
        }

        footer {
            background: #1f2937;
            color: #fff;
            text-align: left;
            padding: 32px 24px;
            font-size: 13px;
            min-height: 80px
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <!-- ===== HEADER ===== -->
        <header>
            <div class="logo">
                <img src="/img/koperasi-jatim-capital-logo.png" alt="Logo Koperasi Berkembang Bersama Kami">
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="/home">Home</a></li>
                    <li><a href="/dashboard">Dashboard</a></li>
                    <li><a href="/login">Log In</a></li>
                    <li><a href="/signup">Sign Up</a></li>
                </ul>
            </nav>

            <div class="user-dropdown">
                <div class="user-circle" id="userMenuToggle">
                    <%= user.first_name.charAt(0).toUpperCase() %>
                </div>
                <div class="user-menu hidden" id="userMenu">
                    <a href="/logout"><i class="fa-solid fa-right-from-bracket" style="color:#dc3545;"></i> Logout</a>
                    <form action="/delete-account" method="POST"
                        onsubmit="return confirm('Apakah Anda yakin ingin menghapus akun Anda?')" style="margin: 0;">
                        <button type="submit" class="delete-account"
                            style="background: none; border: none; width: 100%; text-align: left; padding: 8px 16px; color: #dc3545; font-weight: 500; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <i class="fa-solid fa-trash"></i> Delete Account
                        </button>
                    </form>
                </div>
            </div>
        </header>

        <!-- ===== MAIN ===== -->
        <div class="main">
            <!-- Sidebar -->
            <aside class="sidebar">
                <form action="/upload-profile" method="POST" enctype="multipart/form-data">
                    <% const profileImage=(user.profile_picture && user.profile_picture.trim()!=='' ) ?
                        user.profile_picture : '/img/profile.png' ; %>
                        <label for="profileUpload">
                            <img src="<%= profileImage %>" alt="Profile" onerror="this.src='/img/profile.png';" />
                        </label>
                        <input id="profileUpload" type="file" name="profile_picture" style="display:none"
                            onchange="this.form.submit()" />
                </form>
                <div class="name">
                    <%= user.first_name %>
                        <%= user.last_name %>
                </div>
                <div class="nav">
                    <div class="nav-item" id="goMain">Dashboard</div>
                    <div class="nav-item">Notes</div>
                </div>
            </aside>

            <!-- Content -->
            <div class="content">
                <div class="page-title">
                    <i class="fa-solid fa-house"></i>
                    <span>Pipeline</span>
                </div>

                <!-- ===== Table + Toolbar ===== -->
                <div class="pipeline-wrap">
                    <div class="toolbar">
                        <button id="btnAddRow">Add Row</button>
                        <button id="btnAddCol">Add Column</button>
                        <button id="btnDelRow" class="secondary" disabled>Delete Row</button>
                        <button id="btnDelCol" class="secondary" disabled>Delete Column</button>
                        <button id="btnClear" class="secondary">Clear</button>
                    </div>

                    <div class="table-scroll">
                        <table class="pipeline" id="pipelineTable">
                            <thead id="pipeHead"></thead>
                            <tbody id="pipeBody"></tbody>
                        </table>
                    </div>
                </div>
                <!-- ===== /Table ===== -->
            </div>
        </div>

        <footer>Â© Jatim Capital 2025</footer>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // user menu & nav
            const toggle = document.getElementById("userMenuToggle");
            const menu = document.getElementById("userMenu");
            toggle?.addEventListener("click", () => menu.classList.toggle("hidden"));
            document.addEventListener("click", (e) => {
                if (!toggle?.contains(e.target) && !menu?.contains(e.target)) menu?.classList.add("hidden");
            });
            document.getElementById("goMain")?.addEventListener("click", () => (window.location.href = "/dashboard"));

            // ===== Pipeline Table Logic (reliable row/col selection) =====
            const headersDefault = [
                "No", "Nama", "Badan Usaha", "Bidang Usaha", "Aset Properti",
                "Perkiraan Nilai Aset", "Rencana Pengajuan", "Keterangan", "Bank"
            ];

            let cols = headersDefault.length; // 9
            let rows = 4;                     // 4

            const thead = document.getElementById("pipeHead");
            const tbody = document.getElementById("pipeBody");
            const btnAddRow = document.getElementById("btnAddRow");
            const btnAddCol = document.getElementById("btnAddCol");
            const btnDelRow = document.getElementById("btnDelRow");
            const btnDelCol = document.getElementById("btnDelCol");
            const btnClear = document.getElementById("btnClear");

            // state aktif
            let activeR = 0;
            let activeC = 1;

            function renderHeader() {
                const tr = document.createElement("tr");
                for (let c = 0; c < cols; c++) {
                    const th = document.createElement("th");
                    th.textContent = headersDefault[c] || `Column ${c + 1}`;
                    tr.appendChild(th);
                }
                thead.innerHTML = "";
                thead.appendChild(tr);
            }

            function makeRow(rIndex) {
                const tr = document.createElement("tr");
                for (let c = 0; c < cols; c++) {
                    const td = document.createElement("td");
                    if (c === 0) {
                        td.textContent = String(rIndex + 1); // kolom "No"
                    } else {
                        td.contentEditable = "true";
                    }
                    tr.appendChild(td);
                }
                return tr;
            }

            function renderBody() {
                tbody.innerHTML = "";
                for (let r = 0; r < rows; r++) tbody.appendChild(makeRow(r));
                setActive(activeR, activeC);
            }

            function clearHighlights() {
                tbody.querySelectorAll("td").forEach(td => {
                    td.classList.remove("active-cell", "active-row", "active-col");
                });
            }

            function setActive(r, c) {
                // clamp
                activeR = Math.max(0, Math.min(r, rows - 1));
                activeC = Math.max(0, Math.min(c, cols - 1));
                clearHighlights();

                // highlight row & column
                [...tbody.rows].forEach((tr, ri) => {
                    [...tr.cells].forEach((td, ci) => {
                        if (ri === activeR) td.classList.add("active-row");
                        if (ci === activeC) td.classList.add("active-col");
                        if (ri === activeR && ci === activeC) td.classList.add("active-cell");
                    });
                });

                // tombol hapus enable/disable
                btnDelRow.disabled = rows <= 1;
                btnDelCol.disabled = cols <= 1 || activeC === 0; // kolom No tidak boleh dihapus
            }

            function addRow() {
                tbody.appendChild(makeRow(rows));
                rows++;
                setActive(rows - 1, Math.min(activeC, cols - 1));
            }

            function addCol() {
                const newIndex = cols;
                headersDefault[newIndex] = headersDefault[newIndex] || `Column ${newIndex + 1}`;
                // tambah sel ke tiap baris
                [...tbody.rows].forEach((tr, ri) => {
                    const td = document.createElement("td");
                    td.contentEditable = "true";
                    tr.appendChild(td);
                });
                cols++;
                renderHeader();
                setActive(Math.min(activeR, rows - 1), newIndex);
            }

            function deleteRow() {
                if (rows <= 1) return;
                tbody.deleteRow(activeR);
                rows--;

                // re-number kolom "No"
                [...tbody.rows].forEach((tr, i) => (tr.cells[0].textContent = String(i + 1)));
                setActive(Math.max(0, activeR - 1), Math.min(activeC, cols - 1));
            }

            function deleteCol() {
                if (cols <= 1 || activeC === 0) return; // kolom No tidak boleh dihapus
                const c = activeC;
                [...tbody.rows].forEach(tr => tr.deleteCell(c));
                headersDefault.splice(c, 1);
                cols--;
                renderHeader();
                setActive(Math.min(activeR, rows - 1), Math.max(1, c - 1));
            }

            function clearTable() {
                [...tbody.rows].forEach((tr, r) => {
                    [...tr.cells].forEach((td, c) => { td.textContent = c === 0 ? String(r + 1) : ""; });
                });
                setActive(0, 1);
            }

            // ===== Event Delegation: hitung indeks dinamis saat klik/fokus =====
            tbody.addEventListener("mousedown", (e) => {
                const cell = e.target.closest("td");
                if (!cell) return;
                const rowEl = cell.parentElement;
                const r = Array.prototype.indexOf.call(tbody.rows, rowEl);
                const c = cell.cellIndex;
                setActive(r, c);
            });

            // keyboard navigation (opsional, nyaman dipakai)
            tbody.addEventListener("keydown", (e) => {
                if (e.key === "ArrowDown") { e.preventDefault(); setActive(Math.min(activeR + 1, rows - 1), activeC); }
                if (e.key === "ArrowUp") { e.preventDefault(); setActive(Math.max(activeR - 1, 0), activeC); }
                if (e.key === "ArrowRight") { e.preventDefault(); setActive(activeR, Math.min(activeC + 1, cols - 1)); }
                if (e.key === "ArrowLeft") { e.preventDefault(); setActive(activeR, Math.max(activeC - 1, 0)); }
            });

            // Init
            renderHeader();
            renderBody();

            // Buttons
            btnAddRow.addEventListener("click", addRow);
            btnAddCol.addEventListener("click", addCol);
            btnDelRow.addEventListener("click", deleteRow);
            btnDelCol.addEventListener("click", deleteCol);
            btnClear.addEventListener("click", clearTable);
        });
    </script>
</body>

</html>